{"ast":null,"code":"import { Class, addClass, isArray, getter, deepExtend, setDefaultOptions } from '../../common';\nimport { Layer } from './layer';\nimport { Location } from '../location';\nimport { proxy, on, off, toHyphens, toPixels, convertToHtml } from '../utils';\nimport TemplateService from '../../services/template-service';\nconst CLICK = \"click\";\nconst MOUSE_ENTER = \"mouseenter\";\nconst MOUSE_LEAVE = \"mouseleave\";\nconst extend = Object.assign;\nconst MARKER_CLASS_NAME = \"k-marker\";\nconst MARKER_CLASS = \".\" + MARKER_CLASS_NAME;\nexport class MarkerLayer extends Layer {\n  constructor(map, options) {\n    super(map, options);\n    this._markerClickHandler = proxy(this._markerClick, this);\n    on(this.element, CLICK, MARKER_CLASS, this._markerClickHandler);\n    this.items = [];\n\n    this._load(this._readData());\n  }\n\n  destroy() {\n    super.destroy();\n    off(this.element, CLICK, this._markerClickHandler);\n    this.clear();\n  }\n\n  add(args) {\n    if (isArray(args)) {\n      for (let i = 0; i < args.length; i++) {\n        this._addOne(args[i]);\n      }\n    } else {\n      return this._addOne(args);\n    }\n  }\n\n  remove(marker) {\n    marker.destroy();\n    let index = (this.items || []).indexOf(marker);\n\n    if (index > -1) {\n      this.items.splice(index, 1);\n    }\n  }\n\n  clear() {\n    for (let i = 0; i < this.items.length; i++) {\n      this.items[i].destroy();\n    }\n\n    this.items = [];\n  }\n\n  update(marker) {\n    let location = marker.location();\n\n    if (location) {\n      marker.showAt(this.map.locationToView(location));\n      let args = {\n        marker: marker,\n        layer: this\n      };\n      this.map.trigger('markerActivate', args);\n    }\n  }\n\n  _reset() {\n    super._reset();\n\n    let items = this.items;\n\n    for (let i = 0; i < items.length; i++) {\n      this.update(items[i]);\n    }\n  }\n\n  bind(options, dataItem) {\n    let marker = Marker.create(options, this.options);\n    marker.dataItem = dataItem;\n    let args = {\n      marker: marker,\n      layer: this\n    };\n    let cancelled = this.map.trigger('markerCreated', args);\n\n    if (!cancelled) {\n      this.add(marker);\n      return marker;\n    }\n  }\n\n  _addOne(arg) {\n    let marker = Marker.create(arg, this.options);\n    marker.addTo(this);\n    return marker;\n  }\n\n  _readData() {\n    const data = this.options.data || [];\n    return data;\n  }\n\n  _load(data) {\n    this._data = data;\n    this.clear();\n    let getLocation = getter(this.options.locationField);\n    let getTitle = getter(this.options.titleField);\n\n    for (let i = 0; i < data.length; i++) {\n      let dataItem = data[i];\n      this.bind({\n        location: getLocation(dataItem),\n        title: getTitle(dataItem)\n      }, dataItem);\n    }\n  }\n\n  _markerClick(e) {\n    const marker = e.currentTarget._kendoNode;\n    let args = {\n      layer: this,\n      layerIndex: this._layerIndex(),\n      marker: marker,\n      markerIndex: (this.items || []).indexOf(marker),\n      originalEvent: e\n    };\n    this.map.trigger('markerClick', args);\n  }\n\n  _markerMouseEnter(e) {\n    const args = this._createMarkerEventArgs(e);\n\n    this.map.trigger(\"markerMouseEnter\", args);\n  }\n\n  _markerMouseLeave(e) {\n    const args = this._createMarkerEventArgs(e);\n\n    this.map.trigger(\"markerMouseLeave\", args);\n  }\n\n  _createMarkerEventArgs(e) {\n    const marker = e.marker;\n    let args = extend({}, {\n      layer: this,\n      layerIndex: this._layerIndex(),\n      marker: marker,\n      markerIndex: (this.items || []).indexOf(marker)\n    }, e);\n    return args;\n  }\n\n}\nsetDefaultOptions(MarkerLayer, {\n  zIndex: 1000,\n  autoBind: true,\n  locationField: 'location',\n  titleField: 'title',\n  template: \"\"\n});\nexport class Marker extends Class {\n  constructor(options) {\n    super();\n    this.options = options || {};\n  }\n\n  destroy() {\n    this.layer = null;\n    this.unbindEvents();\n    this.hide();\n  }\n\n  addTo(parent) {\n    this.layer = parent.markers || parent;\n    this.layer.items.push(this);\n    this.layer.update(this);\n  }\n\n  location(value) {\n    if (value) {\n      this.options.location = Location.create(value).toArray();\n\n      if (this.layer) {\n        this.layer.update(this);\n      }\n\n      return this;\n    }\n\n    return Location.create(this.options.location);\n  }\n\n  showAt(point) {\n    this.render();\n    this._anchor = {\n      left: Math.round(point.x),\n      top: Math.round(point.y)\n    };\n    this.element.style.left = toPixels(this._anchor.left);\n    this.element.style.top = toPixels(this._anchor.top);\n  }\n\n  hide() {\n    if (this.element) {\n      this.element.remove();\n      this.element = null;\n    }\n  }\n\n  bindEvents() {\n    if (!this.element) {\n      return;\n    }\n\n    this._mouseEnterHandler = proxy(this._mouseEnter, this);\n    on(this.element, MOUSE_ENTER, MARKER_CLASS, this._mouseEnterHandler);\n    this._mouseLeaveHandler = proxy(this._mouseLeave, this);\n    on(this.element, MOUSE_LEAVE, MARKER_CLASS, this._mouseLeaveHandler);\n  }\n\n  unbindEvents() {\n    if (!this.element) {\n      return;\n    }\n\n    off(this.element, MOUSE_ENTER, this._mouseEnterHandler);\n    off(this.element, MOUSE_LEAVE, this._mouseLeaveHandler);\n  }\n\n  render() {\n    if (!this.element) {\n      let options = this.options;\n      let layer = this.layer;\n      let element = document.createElement('span');\n      addClass(element, MARKER_CLASS_NAME);\n\n      if (this.options.template) {\n        const templateFn = this._compileTemplate(this.options.template);\n\n        const templateHtml = templateFn(this.dataItem);\n        const templateElement = convertToHtml(templateHtml);\n        element.appendChild(templateElement);\n      } else {\n        addClass(element, 'k-icon k-i-marker-' + toHyphens(options.shape || 'pin'));\n      }\n\n      if (options.title) {\n        element.setAttribute(\"title\", options.title);\n      }\n\n      const attributes = options.attributes || {};\n      Object.keys(attributes).forEach(function (key) {\n        element.setAttribute(key, attributes[key]);\n      });\n      element._kendoNode = this;\n      element.style.zIndex = options.zIndex;\n      this.element = element;\n\n      if (layer) {\n        layer.element.appendChild(this.element);\n      }\n\n      this.bindEvents();\n    }\n  }\n\n  _mouseEnter(e) {\n    const args = this._createEventArgs(e);\n\n    this.layer._markerMouseEnter(args);\n\n    this.layer.map._tooltip.show({\n      top: this._anchor.top - this.element.offsetHeight,\n      left: this._anchor.left\n    }, this._tooltipContext());\n  }\n\n  _tooltipContext() {\n    return {\n      type: 'marker',\n      layerIndex: this.layer._layerIndex(),\n      className: 'k-map-marker-tooltip',\n      dataItem: this.dataItem,\n      title: this.options.title,\n      location: this.location()\n    };\n  }\n\n  _mouseLeave(e) {\n    const args = this._createEventArgs(e);\n\n    this.layer._markerMouseLeave(args);\n  }\n\n  _createEventArgs(e) {\n    let args = {\n      marker: this,\n      originalEvent: e\n    };\n    return args;\n  }\n\n  _compileTemplate(template) {\n    return TemplateService.compile(template, {\n      paramName: \"dataItem\",\n      useWithBlock: false\n    });\n  }\n\n  static create(arg, defaults) {\n    if (arg instanceof Marker) {\n      return arg;\n    }\n\n    return new Marker(deepExtend({}, defaults, arg));\n  }\n\n}","map":null,"metadata":{},"sourceType":"module"}