{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\n\nimport { WMLogger } from '@mobilize/logging';\nimport { Model } from './Model';\nimport { Dictionary } from '../Application';\nimport { ErrorCodes, ExceptionHandlerClass } from '../System/Aop';\nimport { Messages } from '../System/Diagnostics';\n\nvar ModelCollection = function () {\n  function ModelCollection() {\n    this.models = new Dictionary();\n    this.removedModels = [];\n  }\n\n  ModelCollection.prototype.add = function (model) {\n    if (this.models.containsKey(model.UniqueID)) {\n      if (this.models.value(model.UniqueID).IsTempModel) {\n        this.models.remove(model.UniqueID);\n      } else {\n        throw new Error(\"there is a problem, can't add a repeated uniqueID into the model collection.\");\n      }\n    }\n\n    this.models.add(model.UniqueID, model);\n  };\n\n  ModelCollection.prototype.apply = function (fn) {\n    if (fn) {\n      this.models.values().forEach(function (item) {\n        return fn(item);\n      });\n    }\n  };\n\n  ModelCollection.prototype.getModel = function (key) {\n    if (this.models.containsKey(key)) {\n      return this.models.value(key);\n    }\n\n    WMLogger.instance().error(Messages.Error.ModelNotFound, {\n      id: key\n    });\n    return null;\n  };\n\n  ModelCollection.prototype.getParentByKey = function (key) {\n    var parentUniqueID = key.substr(key.indexOf(Model.separator) + Model.separator.length);\n    return this.getModel(parentUniqueID);\n  };\n\n  ModelCollection.prototype.getParentByModel = function (model) {\n    return this.getParentByKey(model.UniqueID);\n  };\n\n  ModelCollection.prototype.addRange = function (array) {\n    var _this = this;\n\n    array.forEach(function (element) {\n      _this.add(element);\n    });\n  };\n\n  Object.defineProperty(ModelCollection.prototype, \"length\", {\n    get: function () {\n      return this.models.length;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  ModelCollection.prototype.deleteCascade = function (key) {\n    var model = this.getModel(key);\n\n    if (model) {\n      for (var propertyName in model) {\n        if (this.isValidModelProperty(model, propertyName)) {\n          this.removePointer(propertyName, key);\n        }\n      }\n\n      this.removedModels.push(key);\n      this.models.remove(key);\n    }\n  };\n\n  ModelCollection.prototype.removePointer = function (propertyName, key) {\n    propertyName = propertyName === 'Items' ? '_items' : propertyName;\n    var pointerName = propertyName + Model.separator + key;\n    this.deleteCascade(pointerName);\n  };\n\n  ModelCollection.prototype.isValidModelProperty = function (model, propertyName) {\n    return model.hasOwnProperty(propertyName) && model[propertyName] && model[propertyName].UniqueID;\n  };\n\n  ModelCollection.prototype.replace = function (model) {\n    this.models.replace(model.UniqueID, model);\n  };\n\n  ModelCollection.prototype.switchIds = function (oldUniqueId, newUniqueId) {\n    var model = this.models.value(oldUniqueId);\n    var tempModel = this.models.value(newUniqueId);\n\n    if (model) {\n      model.UniqueID = newUniqueId;\n      this.models.remove(oldUniqueId);\n      this.models.add(newUniqueId, model);\n      var parentArray = this.getParentByKey(newUniqueId);\n\n      if (parentArray && parentArray.isArray) {\n        if (tempModel) {\n          tempModel.UniqueID = oldUniqueId;\n        } else {\n          tempModel = new Model(oldUniqueId);\n        }\n\n        tempModel.IsTempModel = true;\n        this.models.add(oldUniqueId, tempModel);\n        var radix = 10;\n        var oldIndex = parseInt(oldUniqueId.split(Model.separator)[0], radix);\n        var newIndex = parseInt(newUniqueId.split(Model.separator)[0], radix);\n        parentArray.splice(oldIndex, 1, tempModel);\n        parentArray.splice(newIndex, 1, model);\n      }\n    }\n  };\n\n  ModelCollection.prototype.exists = function (model) {\n    return this.models.containsKey(model.UniqueID) && !this.models.value(model.UniqueID).IsTempModel;\n  };\n\n  ModelCollection.prototype.search = function (name) {\n    var model = null;\n    this.models.values().forEach(function (item) {\n      if (item && item.UniqueID && item.UniqueID.indexOf(name) > -1) {\n        model = item;\n      }\n    });\n    return model;\n  };\n\n  ModelCollection.prototype.toArray = function () {\n    return this.models.values();\n  };\n\n  ModelCollection = __decorate([ExceptionHandlerClass(ErrorCodes.ClientCore), __metadata(\"design:paramtypes\", [])], ModelCollection);\n  return ModelCollection;\n}();\n\nexport { ModelCollection }; //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWxDb2xsZWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL0NvcmUvTW9kZWxDb2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWtCQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFHakQ7SUFFSTtRQUNJLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBTUQsNkJBQUcsR0FBSCxVQUFJLEtBQWE7UUFDYixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUN6QyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLEVBQUU7Z0JBQy9DLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUN0QztpQkFBTTtnQkFDSCxNQUFNLElBQUksS0FBSyxDQUFDLDhFQUE4RSxDQUFDLENBQUM7YUFDbkc7U0FDSjtRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELCtCQUFLLEdBQUwsVUFBTSxFQUEwQjtRQUM1QixJQUFJLEVBQUUsRUFBRTtZQUNKLElBQUksQ0FB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QztnQkFHeEUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUMzQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDMUM7U0FDSjtJQUNMLENBQUM7SUFFRCxnQ0FBTSxHQUFOLFVBQU8sS0FBYTtRQUNoQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLENBQUM7SUFDckcsQ0FBQztJQUVELGdDQUFNLEdBQU4sVUFBTyxJQUFZO1FBQ2YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSTtZQUU5QixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUMzRCxLQUFLLEdBQUcsSUFBSSxDQUFDO2FBQ2hCO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsaUNBQU8sR0FBUDtRQUNJLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBMUlRLGVBQWU7UUFEM0IscUJBQXFCLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQzs7T0FDaEMsZUFBZSxDQTJJM0I7SUFBRCxzQkFBQztDQUFBLEFBM0lELElBMklDO1NBM0lZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcclxuKiBDb3B5cmlnaHQgKEMpIE1vYmlsaXplLk5ldCA8aW5mb0Btb2JpbGl6ZS5uZXQ+IC0gQWxsIFJpZ2h0cyBSZXNlcnZlZFxyXG4qXHJcbiogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIE1vYmlsaXplIEZyYW1ld29ya3MsIHdoaWNoIGlzXHJcbiogcHJvcHJpZXRhcnkgYW5kIGNvbmZpZGVudGlhbC5cclxuKlxyXG4qIE5PVElDRTogIEFsbCBpbmZvcm1hdGlvbiBjb250YWluZWQgaGVyZWluIGlzLCBhbmQgcmVtYWluc1xyXG4qIHRoZSBwcm9wZXJ0eSBvZiBNb2JpbGl6ZS5OZXQgQ29ycG9yYXRpb24uXHJcbiogVGhlIGludGVsbGVjdHVhbCBhbmQgdGVjaG5pY2FsIGNvbmNlcHRzIGNvbnRhaW5lZCBoZXJlaW4gYXJlXHJcbiogcHJvcHJpZXRhcnkgdG8gTW9iaWxpemUuTmV0IENvcnBvcmF0aW9uIGFuZCBtYXkgYmUgY292ZXJlZFxyXG4qIGJ5IFUuUy4gUGF0ZW50cywgYW5kIGFyZSBwcm90ZWN0ZWQgYnkgdHJhZGUgc2VjcmV0IG9yIGNvcHlyaWdodCBsYXcuXHJcbiogRGlzc2VtaW5hdGlvbiBvZiB0aGlzIGluZm9ybWF0aW9uIG9yIHJlcHJvZHVjdGlvbiBvZiB0aGlzIG1hdGVyaWFsXHJcbiogaXMgc3RyaWN0bHkgZm9yYmlkZGVuIHVubGVzcyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24gaXMgb2J0YWluZWRcclxuKiBmcm9tIE1vYmlsaXplLk5ldCBDb3Jwb3JhdGlvbi5cclxuKlxyXG4qIFRoaXMgZmlsZSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBhbmQgY29uZGl0aW9ucyBkZWZpbmVkIGluXHJcbiogZmlsZSAnTElDRU5TRS50eHQnLCB3aGljaCBpcyBwYXJ0IG9mIHRoaXMgc291cmNlIGNvZGUgcGFja2FnZS5cclxuKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXHJcbmltcG9ydCB7IFdNTG9nZ2VyIH0gZnJvbSAnQG1vYmlsaXplL2xvZ2dpbmcnO1xyXG5cclxuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICcuL01vZGVsJztcclxuXHJcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi9BcHBsaWNhdGlvbic7XHJcbmltcG9ydCB7IElCdWZmZXIsIElEaWN0aW9uYXJ5LCBJTW9kZWwgfSBmcm9tICcuLi9Db250cmFjdCc7XHJcbmltcG9ydCB7IEVycm9yQ29kZXMsIEV4Y2VwdGlvbkhhbmRsZXJDbGFzcyB9IGZyb20gJy4uL1N5c3RlbS9Bb3AnO1xyXG5pbXBvcnQgeyBNZXNzYWdlcyB9IGZyb20gJy4uL1N5c3RlbS9EaWFnbm9zdGljcyc7XHJcblxyXG5ARXhjZXB0aW9uSGFuZGxlckNsYXNzKEVycm9yQ29kZXMuQ2xpZW50Q29yZSlcclxuZXhwb3J0IGNsYXNzIE1vZGVsQ29sbGVjdGlvbiBpbXBsZW1lbnRzIElCdWZmZXIge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMubW9kZWxzID0gbmV3IERpY3Rpb25hcnkoKTtcclxuICAgICAgICB0aGlzLnJlbW92ZWRNb2RlbHMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVkTW9kZWxzOiBzdHJpbmdbXTtcclxuXHJcbiAgICBwcm90ZWN0ZWQgbW9kZWxzOiBJRGljdGlvbmFyeTtcclxuXHJcbiAgICBhZGQobW9kZWw6IElNb2RlbCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLm1vZGVscy5jb250YWluc0tleShtb2RlbC5VbmlxdWVJRCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubW9kZWxzLnZhbHVlKG1vZGVsLlVuaXF1ZUlEKS5Jc1RlbXBNb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tb2RlbHMucmVtb3ZlKG1vZGVsLlVuaXF1ZUlEKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZXJlIGlzIGEgcHJvYmxlbSwgY2FuJ3QgYWRkIGEgcmVwZWF0ZWQgdW5pcXVlSUQgaW50byB0aGUgbW9kZWwgY29sbGVjdGlvbi5cIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5tb2RlbHMuYWRkKG1vZGVsLlVuaXF1ZUlELCBtb2RlbCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwbHkoZm46IChtb2RlbDogSU1vZGVsKSA9PiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBpZiAoZm4pIHtcclxuICAgICAgICAgICAgdGhpcy5tb2RlbHMudmFsdWVzKCkuZm9yRWFjaCgoaXRlbSkgPT4gZm4oaXRlbSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRNb2RlbChrZXk6IHN0cmluZyk6IElNb2RlbCB7XHJcbiAgICAgICAgaWYgKHRoaXMubW9kZWxzLmNvbnRhaW5zS2V5KGtleSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnZhbHVlKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFdNTG9nZ2VyLmluc3RhbmNlKCkuZXJyb3IoTWVzc2FnZXMuRXJyb3IuTW9kZWxOb3RGb3VuZCwgeyBpZDoga2V5IH0pO1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBhcmVudEJ5S2V5KGtleTogc3RyaW5nKTogSU1vZGVsIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRVbmlxdWVJRCA9IGtleS5zdWJzdHIoa2V5LmluZGV4T2YoTW9kZWwuc2VwYXJhdG9yKSArIE1vZGVsLnNlcGFyYXRvci5sZW5ndGgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldE1vZGVsKHBhcmVudFVuaXF1ZUlEKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQYXJlbnRCeU1vZGVsKG1vZGVsOiBJTW9kZWwpOiBJTW9kZWwge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFBhcmVudEJ5S2V5KG1vZGVsLlVuaXF1ZUlEKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRSYW5nZShhcnJheTogQXJyYXk8SU1vZGVsPik6IHZvaWQge1xyXG4gICAgICAgIGFycmF5LmZvckVhY2goKGVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5hZGQoZWxlbWVudCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vZGVscy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlQ2FzY2FkZShrZXk6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG1vZGVsID0gdGhpcy5nZXRNb2RlbChrZXkpO1xyXG4gICAgICAgIGlmIChtb2RlbCkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5TmFtZSBpbiBtb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNWYWxpZE1vZGVsUHJvcGVydHkobW9kZWwsIHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVBvaW50ZXIocHJvcGVydHlOYW1lLCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlZE1vZGVscy5wdXNoKGtleSk7XHJcbiAgICAgICAgICAgIHRoaXMubW9kZWxzLnJlbW92ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIHRoZSBwcm9wZXJ0eSdzIFVuaXF1ZUlEIG1pZ2h0IGJlIGRpZmZlcmVudCBpZiB0aGUgdmFsdWUgd2FzIHNldCBieSBhIHBvaW50ZXIsXHJcbiAgICAgKiBzbyB0aGUgVW5pcXVlSUQgaXMgcmVjcmVhdGVkIGZvciB0aGUgZGVsZXRlLlxyXG4gICAgICogQHBhcmFtIHByb3BlcnR5TmFtZSB0aGUgY3VycmVudCBwcm9wZXJ0eSBuYW1lIHRvIGNoZWNrXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleSB0byByZXNvbHZlIHRoZSBwb2ludGVyIG5hbWVcclxuICAgICAqL1xyXG4gICAgcmVtb3ZlUG9pbnRlcihwcm9wZXJ0eU5hbWU6IHN0cmluZywga2V5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eU5hbWUgPT09ICdJdGVtcycgPyAnX2l0ZW1zJyA6IHByb3BlcnR5TmFtZTtcclxuICAgICAgICBjb25zdCBwb2ludGVyTmFtZSA9IHByb3BlcnR5TmFtZSArIE1vZGVsLnNlcGFyYXRvciArIGtleTtcclxuICAgICAgICB0aGlzLmRlbGV0ZUNhc2NhZGUocG9pbnRlck5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzVmFsaWRNb2RlbFByb3BlcnR5KG1vZGVsOiBhbnksIHByb3BlcnR5TmFtZTogc3RyaW5nKTogYW55IHtcclxuICAgICAgICByZXR1cm4gKG1vZGVsLmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkgJiYgbW9kZWxbcHJvcGVydHlOYW1lXSAmJiBtb2RlbFtwcm9wZXJ0eU5hbWVdLlVuaXF1ZUlEKTtcclxuICAgIH1cclxuXHJcbiAgICByZXBsYWNlKG1vZGVsOiBJTW9kZWwpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLm1vZGVscy5yZXBsYWNlKG1vZGVsLlVuaXF1ZUlELCBtb2RlbCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3dpdGNoSWRzKG9sZFVuaXF1ZUlkOiBzdHJpbmcsIG5ld1VuaXF1ZUlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWxzLnZhbHVlKG9sZFVuaXF1ZUlkKTtcclxuICAgICAgICBsZXQgdGVtcE1vZGVsID0gdGhpcy5tb2RlbHMudmFsdWUobmV3VW5pcXVlSWQpO1xyXG4gICAgICAgIGlmIChtb2RlbCkge1xyXG4gICAgICAgICAgICBtb2RlbC5VbmlxdWVJRCA9IG5ld1VuaXF1ZUlkO1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVscy5yZW1vdmUob2xkVW5pcXVlSWQpO1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVscy5hZGQobmV3VW5pcXVlSWQsIG1vZGVsKTtcclxuXHJcbiAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgbW9kZWxzJ3MgaW5kZXggaW4gdGhlIHBhcmVudCBhcnJheSBhZnRlciBzd2l0Y2hpbmcgdGhlIElEc1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRBcnJheSA9IHRoaXMuZ2V0UGFyZW50QnlLZXkobmV3VW5pcXVlSWQpIGFzIGFueTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudEFycmF5ICYmIHBhcmVudEFycmF5LmlzQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0ZW1wTW9kZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZW1wTW9kZWwuVW5pcXVlSUQgPSBvbGRVbmlxdWVJZDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcE1vZGVsID0gbmV3IE1vZGVsKG9sZFVuaXF1ZUlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRlbXBNb2RlbC5Jc1RlbXBNb2RlbCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gdGhlIHRlbXBNb2RlbCBpcyBleHBlY3RlZCB0byBiZSByZW1vdmVkIHdoZW4gcHJvY2Vzc2luZyB0aGUgZGVsdGFzXHJcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGVscy5hZGQob2xkVW5pcXVlSWQsIHRlbXBNb2RlbCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcmFkaXggPSAxMDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9sZEluZGV4ID0gcGFyc2VJbnQob2xkVW5pcXVlSWQuc3BsaXQoTW9kZWwuc2VwYXJhdG9yKVswXSwgcmFkaXgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSBwYXJzZUludChuZXdVbmlxdWVJZC5zcGxpdChNb2RlbC5zZXBhcmF0b3IpWzBdLCByYWRpeCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gcmVwbGFjZSB0aGUgbW9kZWxzIGluIHRoZSBwYXJlbnQgYXJyYXkgd2l0aCBzcGxpY2UgdG8gdXNlIG92ZXJsb2FkZWQgYXJyYXkgZnVuY3Rpb25zIChpZiBhbnkpXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRBcnJheS5zcGxpY2Uob2xkSW5kZXgsIDEsIHRlbXBNb2RlbCk7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnRBcnJheS5zcGxpY2UobmV3SW5kZXgsIDEsIG1vZGVsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleGlzdHMobW9kZWw6IElNb2RlbCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vZGVscy5jb250YWluc0tleShtb2RlbC5VbmlxdWVJRCkgJiYgIXRoaXMubW9kZWxzLnZhbHVlKG1vZGVsLlVuaXF1ZUlEKS5Jc1RlbXBNb2RlbDtcclxuICAgIH1cclxuXHJcbiAgICBzZWFyY2gobmFtZTogc3RyaW5nKTogSU1vZGVsIHtcclxuICAgICAgICBsZXQgbW9kZWwgPSBudWxsO1xyXG4gICAgICAgIHRoaXMubW9kZWxzLnZhbHVlcygpLmZvckVhY2goKGl0ZW0pID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0uVW5pcXVlSUQgJiYgaXRlbS5VbmlxdWVJRC5pbmRleE9mKG5hbWUpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIG1vZGVsID0gaXRlbTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gbW9kZWw7XHJcbiAgICB9XHJcblxyXG4gICAgdG9BcnJheSgpOiBBcnJheTxJTW9kZWw+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tb2RlbHMudmFsdWVzKCk7XHJcbiAgICB9XHJcbn1cclxuIl19","map":null,"metadata":{},"sourceType":"module"}