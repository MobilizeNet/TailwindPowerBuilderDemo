{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\n\nimport { WMLogger } from '@mobilize/logging';\nimport { Constants, ContentType, Events } from '../Contract';\nimport { Response } from '../Server';\nimport { Exception, ExceptionHandler, NetworkException } from '../System';\nimport { Inject, PendingEvent } from './';\nexport var ActionState = /*#__PURE__*/(() => {\n  (function (ActionState) {\n    ActionState[ActionState[\"Sending\"] = 0] = \"Sending\";\n    ActionState[ActionState[\"Idle\"] = 1] = \"Idle\";\n  })(ActionState || (ActionState = {}));\n\n  return ActionState;\n})();\n\nvar ActionService = function () {\n  function ActionService(inject) {\n    var _this = this;\n\n    if (inject === void 0) {\n      inject = null;\n    }\n\n    this.inject = inject || Inject.Instance;\n    this.http = this.inject.resolve(Constants.Server);\n    this.urlResolver = this.inject.resolve(Constants.UrlResolver);\n    this.changeBuffer = this.inject.resolve(Constants.NotifyBuffer);\n    this.pendingEvents = new Array();\n    this.event = this.inject.resolve(Constants.EventAggregator);\n    this.state = ActionState.Idle;\n    this.requestBuilder = this.inject.resolve(Constants.RequestBuilder);\n    this.commandGenerators = [];\n\n    if (this.event) {\n      this.event.subscribe(Events.PreActionCommandGeneratorRegistration, function (generator) {\n        _this.addCommandGenerator(generator);\n      });\n      this.event.subscribe(Events.PreActionCommandGeneratorDeregistration, function (generator) {\n        _this.removeCommandGenerator(generator);\n      });\n      this.event.subscribe(Events.DeletePendingActions, function (id) {\n        _this.deletePendingEvents(id);\n      });\n    }\n  }\n\n  ActionService.prototype.send = function (action, includeDirty) {\n    var request = this.requestBuilder.create(action);\n\n    if (action.requestConfig.includeDirty) {\n      request.dirty = this.changeBuffer.getChanges();\n    }\n\n    if (request.commands) {\n      request.commands = this.buildCommandGenerators().map(function (c) {\n        delete c.receiverId;\n        return c;\n      });\n    }\n\n    if (action.highPriority) {\n      this.pendingEvents.unshift(new PendingEvent(action, request));\n    } else {\n      this.pendingEvents.push(new PendingEvent(action, request));\n    }\n\n    this.sendActions();\n  };\n\n  ActionService.prototype.sendImmediateAction = function (action, includeDirty) {};\n\n  ActionService.prototype.getEvents = function () {\n    return this.pendingEvents;\n  };\n\n  ActionService.prototype.addCommandGenerator = function (commandGenerator) {\n    if (this.commandGenerators.indexOf(commandGenerator) === -1) {\n      this.commandGenerators.push(commandGenerator);\n    }\n  };\n\n  ActionService.prototype.removeCommandGenerator = function (commandGenerator) {\n    var index = this.commandGenerators.indexOf(commandGenerator);\n\n    if (index !== -1) {\n      this.commandGenerators.splice(index, 1);\n      this.commandGenerators[index] = this.commandGenerators[this.commandGenerators.length - 1];\n      this.commandGenerators.pop();\n    }\n  };\n\n  ActionService.prototype.sendActions = function () {\n    var _this = this;\n\n    if (this.state === ActionState.Idle) {\n      this.state = ActionState.Sending;\n      var event_1 = this.pendingEvents.shift();\n      var data = void 0;\n\n      switch (event_1.action.requestConfig.contentType) {\n        case ContentType.multipartFormdata:\n          data = event_1.request;\n          break;\n\n        case ContentType.applicationJson:\n          data = JSON.stringify(event_1.request);\n          break;\n\n        default:\n          data = JSON.stringify(event_1.request);\n          break;\n      }\n\n      this.http.post(this.urlResolver.resolveUrl(event_1.action), data, function (response) {\n        _this.handleResponse(event_1.action, response);\n      }, event_1.action.requestConfig);\n    }\n  };\n\n  ActionService.prototype.handleResponse = function (action, response) {\n    if (response === undefined || response.status && response.status !== 200) {\n      this.event.publish(Events.Error, new NetworkException(response.responseText, response.status));\n      this.processCallbacks(action, new Response(response));\n      WMLogger.instance().error('The response is undefined or with a wrong status');\n    } else if (response.ErrorOcurred) {\n      this.event.publish(Events.Error, new Exception(response.ExMessage + \"\\n\" + response.ExStackTrace));\n      this.state = ActionState.Idle;\n      WMLogger.instance().error('An error ocurred processing the request');\n    } else {\n      this.processActionResponse(action, new Response(response));\n    }\n  };\n\n  ActionService.prototype.buildCommandGenerators = function () {\n    if (this.commandGenerators.length === 0) {\n      return [];\n    }\n\n    return this.commandGenerators.map(function (c) {\n      return c();\n    }).filter(function (command) {\n      return command != null;\n    });\n  };\n\n  ActionService.prototype.deletePendingEvents = function (ids) {\n    if (this.pendingEvents && ids && ids.length > 0) {\n      this.pendingEvents = this.pendingEvents.filter(function (pending) {\n        return ids.indexOf(pending.action.receiverId) === -1;\n      });\n    }\n  };\n\n  ActionService.prototype.processActionResponse = function (action, response) {\n    this.event.publish(Events.ApplyDeltas, response);\n    this.processCallbacks(action, response);\n  };\n\n  ActionService.prototype.processCallbacks = function (action, response) {\n    try {\n      if (action.callback) {\n        action.callback(response);\n      }\n    } finally {\n      this.processPending();\n    }\n  };\n\n  ActionService.prototype.processPending = function () {\n    this.state = ActionState.Idle;\n\n    if (this.pendingEvents.length > 0) {\n      this.sendActions();\n    }\n  };\n\n  ActionService.prototype.onException = function () {\n    this.state = ActionState.Idle;\n    this.processPending();\n  };\n\n  __decorate([ExceptionHandler('onException'), __metadata(\"design:type\", Function), __metadata(\"design:paramtypes\", []), __metadata(\"design:returntype\", void 0)], ActionService.prototype, \"sendActions\", null);\n\n  return ActionService;\n}();\n\nexport { ActionService }; //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWN0aW9uU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BcHBsaWNhdGlvbi9BY3Rpb25TZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWtCQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFN0MsT0FBTyxFQUNILFNBQVMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUVqQyxNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFMUUsT0FBTyxFQUFlLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFFdkQsTUFBTSxDQUFOLElBQVksV0FHWDtBQUhELFdBQVksV0FBVztJQUNuQixtREFBTyxDQUFBO0lBQ1AsNkNBQUksQ0FBQTtBQUNSLENBQUMsRUFIVyxXQUFXLEtBQVgsV0FBVyxRQUd0QjtBQUVEO0lBRUksdUJBQVksTUFBc0I7UUFBbEMsaUJBc0JDO1FBdEJXLHVCQUFBLEVBQUEsYUFBc0I7UUFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUN4QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksS0FBSyxFQUFnQixDQUFDO1FBQy9DLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztRQUM5QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNaLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxxQ0FBcUMsRUFBRSxVQUFDLFNBQVM7Z0JBQ3pFLEtBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN4QyxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyx1Q0FBdUMsRUFBRSxVQUFDLFNBQVM7Z0JBQzNFLEtBQUksQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzQyxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxVQUFDLEVBQU87Z0JBQ3RELEtBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztTQUVOO0lBQ0wsQ0FBQztJQVlELDRCQUFJLEdBQUosVUFBSyxNQUFvQixFQUFFLFlBQXNCO1FBQzdDLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25ELElBQUksTUFBTSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUU7WUFDbkMsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQ2xCLE9BQU8sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBQztnQkFDbkQsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDO2dCQUNwQixPQUFPLENBQUMsQ0FBQztZQUNiLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxZQUFZLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDakU7YUFBTTtZQUNILElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksWUFBWSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzlEO1FBQ0QsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCwyQ0FBbUIsR0FBbkIsVUFBb0IsTUFBb0IsRUFBRSxZQUFzQixJQUFTLENBQUM7SUFFMUUsaUNBQVMsR0FBVDtRQUNJLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM5QixDQUFDO0lBRUQsMkNBQW1CLEdBQW5CLFVBQW9CLGdCQUF1QztRQUN2RCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUN6RCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDakQ7SUFDTCxDQUFDO0lBRUQsOENBQXNCLEdBQXRCLFVBQXVCLGdCQUF1QztRQUMxRCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDL0QsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDZCxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDMUYsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQztJQUdTLG1DQUFXLEdBQXJCO1FBREEsaUJBb0JDO1FBbEJHLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxXQUFXLENBQUMsSUFBSSxFQUFFO1lBQ2pDLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztZQUNqQyxJQUFNLE9BQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3pDLElBQUksSUFBSSxTQUFLLENBQUM7WUFDZCxRQUFRLE9BQUssQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRTtnQkFDNUMsS0FBSyxXQUFXLENBQUMsaUJBQWlCO29CQUM5QixJQUFJLEdBQUcsT0FBSyxDQUFDLE9BQU8sQ0FBQztvQkFDckIsTUFBTTtnQkFDVixLQUFLLFdBQVcsQ0FBQyxlQUFlO29CQUM1QixJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3JDLE1BQU07Z0JBQ1Y7b0JBQ0ksSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUNyQyxNQUFNO2FBQ2I7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxPQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUMxRCxVQUFDLFFBQVEsSUFBTyxLQUFJLENBQUMsY0FBYyxDQUFDLE9BQUssQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNuRztJQUNMLENBQUM7SUFFUyxzQ0FBYyxHQUF4QixVQUF5QixNQUFvQixFQUFFLFFBQWE7UUFDeEQsSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO1lBQ3hFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQy9GLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUN0RCxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7U0FDakY7YUFBTSxJQUFJLFFBQVEsQ0FBQyxZQUFZLEVBQUU7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxJQUFJLFNBQVMsQ0FBSSxRQUFRLENBQUMsU0FBUyxVQUFLLFFBQVEsQ0FBQyxZQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ25HLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztZQUM5QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7U0FDeEU7YUFBTTtZQUNILElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUM5RDtJQUNMLENBQUM7SUFFUyw4Q0FBc0IsR0FBaEM7UUFDSSxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3JDLE9BQU8sRUFBRSxDQUFDO1NBQ2I7UUFDRCxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxDQUFDLEVBQUUsRUFBSCxDQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxPQUFPLElBQUksT0FBQSxPQUFPLElBQUksSUFBSSxFQUFmLENBQWUsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7SUFRUywyQ0FBbUIsR0FBN0IsVUFBOEIsR0FBYTtRQUN2QyxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQSxPQUFPLElBQUksT0FBQSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQTdDLENBQTZDLENBQUMsQ0FBQztTQUM1RztJQUNMLENBQUM7SUFFTyw2Q0FBcUIsR0FBN0IsVUFBOEIsTUFBb0IsRUFBRSxRQUFtQjtRQUNuRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLHdDQUFnQixHQUF4QixVQUF5QixNQUFvQixFQUFFLFFBQW1CO1FBQzlELElBQUk7WUFDQSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUU7Z0JBQ2pCLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDN0I7U0FDSjtnQkFDTztZQUNKLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN6QjtJQUNMLENBQUM7SUFFTyxzQ0FBYyxHQUF0QjtRQUNJLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztRQUM5QixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdEI7SUFDTCxDQUFDO0lBR08sbUNBQVcsR0FBbkI7UUFDSSxJQUFJLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUM7UUFDOUIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFqRkQ7UUFEQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUM7Ozs7b0RBb0IvQjtJQWdFTCxvQkFBQztDQUFBLEFBaEtELElBZ0tDO1NBaEtZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcclxuKiBDb3B5cmlnaHQgKEMpIE1vYmlsaXplLk5ldCA8aW5mb0Btb2JpbGl6ZS5uZXQ+IC0gQWxsIFJpZ2h0cyBSZXNlcnZlZFxyXG4qXHJcbiogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIE1vYmlsaXplIEZyYW1ld29ya3MsIHdoaWNoIGlzXHJcbiogcHJvcHJpZXRhcnkgYW5kIGNvbmZpZGVudGlhbC5cclxuKlxyXG4qIE5PVElDRTogIEFsbCBpbmZvcm1hdGlvbiBjb250YWluZWQgaGVyZWluIGlzLCBhbmQgcmVtYWluc1xyXG4qIHRoZSBwcm9wZXJ0eSBvZiBNb2JpbGl6ZS5OZXQgQ29ycG9yYXRpb24uXHJcbiogVGhlIGludGVsbGVjdHVhbCBhbmQgdGVjaG5pY2FsIGNvbmNlcHRzIGNvbnRhaW5lZCBoZXJlaW4gYXJlXHJcbiogcHJvcHJpZXRhcnkgdG8gTW9iaWxpemUuTmV0IENvcnBvcmF0aW9uIGFuZCBtYXkgYmUgY292ZXJlZFxyXG4qIGJ5IFUuUy4gUGF0ZW50cywgYW5kIGFyZSBwcm90ZWN0ZWQgYnkgdHJhZGUgc2VjcmV0IG9yIGNvcHlyaWdodCBsYXcuXHJcbiogRGlzc2VtaW5hdGlvbiBvZiB0aGlzIGluZm9ybWF0aW9uIG9yIHJlcHJvZHVjdGlvbiBvZiB0aGlzIG1hdGVyaWFsXHJcbiogaXMgc3RyaWN0bHkgZm9yYmlkZGVuIHVubGVzcyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24gaXMgb2J0YWluZWRcclxuKiBmcm9tIE1vYmlsaXplLk5ldCBDb3Jwb3JhdGlvbi5cclxuKlxyXG4qIFRoaXMgZmlsZSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBhbmQgY29uZGl0aW9ucyBkZWZpbmVkIGluXHJcbiogZmlsZSAnTElDRU5TRS50eHQnLCB3aGljaCBpcyBwYXJ0IG9mIHRoaXMgc291cmNlIGNvZGUgcGFja2FnZS5cclxuKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXHJcbmltcG9ydCB7IFdNTG9nZ2VyIH0gZnJvbSAnQG1vYmlsaXplL2xvZ2dpbmcnO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIENvbnN0YW50cywgQ29udGVudFR5cGUsIEV2ZW50cywgSUFjdGlvbiwgSUFjdGlvbk1vZGVsLCBJQ2hhbmdlQnVmZmVyLCBJRXZlbnRBZ2dyZWdhdG9yLCBJSW5qZWN0LFxyXG4gICAgSVJlcXVlc3RCdWlsZGVyLCBJUmVxdWVzdENvbW1hbmQsIElSZXNwb25zZSwgSVNlcnZlciwgSVVybFJlc29sdmVyXHJcbn0gZnJvbSAnLi4vQ29udHJhY3QnO1xyXG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJy4uL1NlcnZlcic7XHJcbmltcG9ydCB7IEV4Y2VwdGlvbiwgRXhjZXB0aW9uSGFuZGxlciwgTmV0d29ya0V4Y2VwdGlvbiB9IGZyb20gJy4uL1N5c3RlbSc7XHJcblxyXG5pbXBvcnQgeyBBY3Rpb25Nb2RlbCwgSW5qZWN0LCBQZW5kaW5nRXZlbnQgfSBmcm9tICcuLyc7XHJcblxyXG5leHBvcnQgZW51bSBBY3Rpb25TdGF0ZSB7XHJcbiAgICBTZW5kaW5nLFxyXG4gICAgSWRsZVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQWN0aW9uU2VydmljZSBpbXBsZW1lbnRzIElBY3Rpb24ge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGluamVjdDogSUluamVjdCA9IG51bGwpIHtcclxuICAgICAgICB0aGlzLmluamVjdCA9IGluamVjdCB8fCBJbmplY3QuSW5zdGFuY2U7XHJcbiAgICAgICAgdGhpcy5odHRwID0gdGhpcy5pbmplY3QucmVzb2x2ZShDb25zdGFudHMuU2VydmVyKTtcclxuICAgICAgICB0aGlzLnVybFJlc29sdmVyID0gdGhpcy5pbmplY3QucmVzb2x2ZShDb25zdGFudHMuVXJsUmVzb2x2ZXIpO1xyXG4gICAgICAgIHRoaXMuY2hhbmdlQnVmZmVyID0gdGhpcy5pbmplY3QucmVzb2x2ZShDb25zdGFudHMuTm90aWZ5QnVmZmVyKTtcclxuICAgICAgICB0aGlzLnBlbmRpbmdFdmVudHMgPSBuZXcgQXJyYXk8UGVuZGluZ0V2ZW50PigpO1xyXG4gICAgICAgIHRoaXMuZXZlbnQgPSB0aGlzLmluamVjdC5yZXNvbHZlKENvbnN0YW50cy5FdmVudEFnZ3JlZ2F0b3IpO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBBY3Rpb25TdGF0ZS5JZGxlO1xyXG4gICAgICAgIHRoaXMucmVxdWVzdEJ1aWxkZXIgPSB0aGlzLmluamVjdC5yZXNvbHZlKENvbnN0YW50cy5SZXF1ZXN0QnVpbGRlcik7XHJcbiAgICAgICAgdGhpcy5jb21tYW5kR2VuZXJhdG9ycyA9IFtdO1xyXG4gICAgICAgIGlmICh0aGlzLmV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnQuc3Vic2NyaWJlKEV2ZW50cy5QcmVBY3Rpb25Db21tYW5kR2VuZXJhdG9yUmVnaXN0cmF0aW9uLCAoZ2VuZXJhdG9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZENvbW1hbmRHZW5lcmF0b3IoZ2VuZXJhdG9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnQuc3Vic2NyaWJlKEV2ZW50cy5QcmVBY3Rpb25Db21tYW5kR2VuZXJhdG9yRGVyZWdpc3RyYXRpb24sIChnZW5lcmF0b3IpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQ29tbWFuZEdlbmVyYXRvcihnZW5lcmF0b3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5ldmVudC5zdWJzY3JpYmUoRXZlbnRzLkRlbGV0ZVBlbmRpbmdBY3Rpb25zLCAoaWQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVQZW5kaW5nRXZlbnRzKGlkKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcGVuZGluZ0V2ZW50czogQXJyYXk8UGVuZGluZ0V2ZW50PjtcclxuICAgIHByb3RlY3RlZCBodHRwOiBJU2VydmVyO1xyXG4gICAgcHJvdGVjdGVkIGNoYW5nZUJ1ZmZlcjogSUNoYW5nZUJ1ZmZlcjtcclxuICAgIHByb3RlY3RlZCB1cmxSZXNvbHZlcjogSVVybFJlc29sdmVyO1xyXG4gICAgcHJvdGVjdGVkIHN0YXRlOiBBY3Rpb25TdGF0ZTtcclxuICAgIHByb3RlY3RlZCByZXF1ZXN0QnVpbGRlcjogSVJlcXVlc3RCdWlsZGVyO1xyXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGluamVjdDogSUluamVjdDtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnQ6IElFdmVudEFnZ3JlZ2F0b3I7XHJcbiAgICBwcml2YXRlIGNvbW1hbmRHZW5lcmF0b3JzOiBBcnJheTwoKSA9PiBJUmVxdWVzdENvbW1hbmQ+O1xyXG5cclxuICAgIHNlbmQoYWN0aW9uOiBJQWN0aW9uTW9kZWwsIGluY2x1ZGVEaXJ0eT86IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0QnVpbGRlci5jcmVhdGUoYWN0aW9uKTtcclxuICAgICAgICBpZiAoYWN0aW9uLnJlcXVlc3RDb25maWcuaW5jbHVkZURpcnR5KSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3QuZGlydHkgPSB0aGlzLmNoYW5nZUJ1ZmZlci5nZXRDaGFuZ2VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZXF1ZXN0LmNvbW1hbmRzKSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3QuY29tbWFuZHMgPSB0aGlzLmJ1aWxkQ29tbWFuZEdlbmVyYXRvcnMoKS5tYXAoKGMpID0+IHtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSBjLnJlY2VpdmVySWQ7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhY3Rpb24uaGlnaFByaW9yaXR5KSB7XHJcbiAgICAgICAgICAgIHRoaXMucGVuZGluZ0V2ZW50cy51bnNoaWZ0KG5ldyBQZW5kaW5nRXZlbnQoYWN0aW9uLCByZXF1ZXN0KSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wZW5kaW5nRXZlbnRzLnB1c2gobmV3IFBlbmRpbmdFdmVudChhY3Rpb24sIHJlcXVlc3QpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZW5kQWN0aW9ucygpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRJbW1lZGlhdGVBY3Rpb24oYWN0aW9uOiBJQWN0aW9uTW9kZWwsIGluY2x1ZGVEaXJ0eT86IGJvb2xlYW4pOiB2b2lkIHt9XHJcblxyXG4gICAgZ2V0RXZlbnRzKCk6IGFueVtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wZW5kaW5nRXZlbnRzO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZENvbW1hbmRHZW5lcmF0b3IoY29tbWFuZEdlbmVyYXRvcjogKCkgPT4gSVJlcXVlc3RDb21tYW5kKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbWFuZEdlbmVyYXRvcnMuaW5kZXhPZihjb21tYW5kR2VuZXJhdG9yKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21tYW5kR2VuZXJhdG9ycy5wdXNoKGNvbW1hbmRHZW5lcmF0b3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVDb21tYW5kR2VuZXJhdG9yKGNvbW1hbmRHZW5lcmF0b3I6ICgpID0+IElSZXF1ZXN0Q29tbWFuZCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jb21tYW5kR2VuZXJhdG9ycy5pbmRleE9mKGNvbW1hbmRHZW5lcmF0b3IpO1xyXG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21tYW5kR2VuZXJhdG9ycy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmRHZW5lcmF0b3JzW2luZGV4XSA9IHRoaXMuY29tbWFuZEdlbmVyYXRvcnNbdGhpcy5jb21tYW5kR2VuZXJhdG9ycy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgdGhpcy5jb21tYW5kR2VuZXJhdG9ycy5wb3AoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgQEV4Y2VwdGlvbkhhbmRsZXIoJ29uRXhjZXB0aW9uJylcclxuICAgIHByb3RlY3RlZCBzZW5kQWN0aW9ucygpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gQWN0aW9uU3RhdGUuSWRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlID0gQWN0aW9uU3RhdGUuU2VuZGluZztcclxuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLnBlbmRpbmdFdmVudHMuc2hpZnQoKTtcclxuICAgICAgICAgICAgbGV0IGRhdGE6IGFueTtcclxuICAgICAgICAgICAgc3dpdGNoIChldmVudC5hY3Rpb24ucmVxdWVzdENvbmZpZy5jb250ZW50VHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBDb250ZW50VHlwZS5tdWx0aXBhcnRGb3JtZGF0YTpcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZXZlbnQucmVxdWVzdDtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgQ29udGVudFR5cGUuYXBwbGljYXRpb25Kc29uOlxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShldmVudC5yZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGV2ZW50LnJlcXVlc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaHR0cC5wb3N0KHRoaXMudXJsUmVzb2x2ZXIucmVzb2x2ZVVybChldmVudC5hY3Rpb24pLCBkYXRhLFxyXG4gICAgICAgICAgICAgICAgKHJlc3BvbnNlKSA9PiB7IHRoaXMuaGFuZGxlUmVzcG9uc2UoZXZlbnQuYWN0aW9uLCByZXNwb25zZSk7IH0sIGV2ZW50LmFjdGlvbi5yZXF1ZXN0Q29uZmlnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGhhbmRsZVJlc3BvbnNlKGFjdGlvbjogSUFjdGlvbk1vZGVsLCByZXNwb25zZTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKChyZXNwb25zZSA9PT0gdW5kZWZpbmVkKSB8fCByZXNwb25zZS5zdGF0dXMgJiYgcmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcclxuICAgICAgICAgICAgdGhpcy5ldmVudC5wdWJsaXNoKEV2ZW50cy5FcnJvciwgbmV3IE5ldHdvcmtFeGNlcHRpb24ocmVzcG9uc2UucmVzcG9uc2VUZXh0LCByZXNwb25zZS5zdGF0dXMpKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ2FsbGJhY2tzKGFjdGlvbiwgbmV3IFJlc3BvbnNlKHJlc3BvbnNlKSk7XHJcbiAgICAgICAgICAgIFdNTG9nZ2VyLmluc3RhbmNlKCkuZXJyb3IoJ1RoZSByZXNwb25zZSBpcyB1bmRlZmluZWQgb3Igd2l0aCBhIHdyb25nIHN0YXR1cycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuRXJyb3JPY3VycmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnQucHVibGlzaChFdmVudHMuRXJyb3IsIG5ldyBFeGNlcHRpb24oYCR7cmVzcG9uc2UuRXhNZXNzYWdlfVxcbiR7cmVzcG9uc2UuRXhTdGFja1RyYWNlfWApKTtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IEFjdGlvblN0YXRlLklkbGU7XHJcbiAgICAgICAgICAgIFdNTG9nZ2VyLmluc3RhbmNlKCkuZXJyb3IoJ0FuIGVycm9yIG9jdXJyZWQgcHJvY2Vzc2luZyB0aGUgcmVxdWVzdCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0FjdGlvblJlc3BvbnNlKGFjdGlvbiwgbmV3IFJlc3BvbnNlKHJlc3BvbnNlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBidWlsZENvbW1hbmRHZW5lcmF0b3JzKCk6IEFycmF5PElSZXF1ZXN0Q29tbWFuZD4ge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmRHZW5lcmF0b3JzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRHZW5lcmF0b3JzLm1hcCgoYykgPT4gYygpKS5maWx0ZXIoY29tbWFuZCA9PiBjb21tYW5kICE9IG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRGVsZXRlcyBwZW5kaW5nIGFjdGlvbnNcclxuICAgICAqIERlbGV0ZSBhbnkgcGVuZGluZyBhY3Rpb24gdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGhcclxuICAgICAqIHRoZSByZWNlaXZlZCBpZDtcclxuICAgICAqIEBwYXJhbSBpZCB0aGUgaWQgdG8gdmVyaWZ5IGlmIHBlbmRpbmcgYWN0aW9ucyBleGlzdHNcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGRlbGV0ZVBlbmRpbmdFdmVudHMoaWRzOiBzdHJpbmdbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnBlbmRpbmdFdmVudHMgJiYgaWRzICYmIGlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGVuZGluZ0V2ZW50cyA9IHRoaXMucGVuZGluZ0V2ZW50cy5maWx0ZXIocGVuZGluZyA9PiBpZHMuaW5kZXhPZihwZW5kaW5nLmFjdGlvbi5yZWNlaXZlcklkKSA9PT0gLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NBY3Rpb25SZXNwb25zZShhY3Rpb246IElBY3Rpb25Nb2RlbCwgcmVzcG9uc2U6IElSZXNwb25zZSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZXZlbnQucHVibGlzaChFdmVudHMuQXBwbHlEZWx0YXMsIHJlc3BvbnNlKTtcclxuICAgICAgICB0aGlzLnByb2Nlc3NDYWxsYmFja3MoYWN0aW9uLCByZXNwb25zZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwcm9jZXNzQ2FsbGJhY2tzKGFjdGlvbjogSUFjdGlvbk1vZGVsLCByZXNwb25zZTogSVJlc3BvbnNlKTogdm9pZCB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGFjdGlvbi5jYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgYWN0aW9uLmNhbGxiYWNrKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBmaW5hbGx5IHtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUGVuZGluZygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NQZW5kaW5nKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBBY3Rpb25TdGF0ZS5JZGxlO1xyXG4gICAgICAgIGlmICh0aGlzLnBlbmRpbmdFdmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbmRBY3Rpb25zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qdHNsaW50OmRpc2FibGU6bm8tdW51c2VkLXZhcmlhYmxlICovXHJcbiAgICBwcml2YXRlIG9uRXhjZXB0aW9uKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBBY3Rpb25TdGF0ZS5JZGxlO1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc1BlbmRpbmcoKTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19","map":null,"metadata":{},"sourceType":"module"}